// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  password   String
  firstName  String
  lastName   String
  role       String   @default("user")
  customerId String?  @map("customer_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  customer Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([role])
  @@map("users")
}

model Customer {
  id        String         @id @default(uuid())
  name      String
  email     String         @unique
  plan      Plan           @default(STARTER)
  status    CustomerStatus @default(ACTIVE)
  metadata  Json?
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  users            User[]
  integrations     Integration[]
  complianceChecks ComplianceCheck[]
  evidence         Evidence[]
  jiraTasks        JiraTask[]

  @@index([email])
  @@index([status])
  @@map("customers")
}

enum Plan {
  STARTER
  GROWTH
  ENTERPRISE
}

enum CustomerStatus {
  ACTIVE
  SUSPENDED
  CANCELED
}

model Integration {
  id          String            @id @default(uuid())
  customerId  String            @map("customer_id")
  type        IntegrationType
  status      IntegrationStatus @default(DISCONNECTED)
  config      Json // Encrypted credentials
  lastSyncAt  DateTime?         @map("last_sync_at")
  healthScore Decimal?          @map("health_score") @db.Decimal(3, 2)
  errorCount  Int               @default(0) @map("error_count")
  lastError   String?           @map("last_error")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  customer Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  evidence Evidence[]

  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([customerId, type])
  @@index([customerId, status])
  @@map("integrations")
}

enum IntegrationType {
  AWS
  GITHUB
  OKTA
  JIRA
  SLACK
}

enum IntegrationStatus {
  ACTIVE
  FAILED
  DISCONNECTED
  SYNCING
}

model Control {
  id              String           @id @default(uuid())
  framework       Framework
  controlId       String           @map("control_id") // e.g., CC6.1, A1.2
  title           String
  description     String           @db.Text
  testProcedure   String           @map("test_procedure") @db.Text
  frequency       Frequency
  category        String?
  integrationType IntegrationType?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  complianceChecks ComplianceCheck[]
  evidence         Evidence[]

  @@unique([framework, controlId])
  @@index([framework])
  @@index([category])
  @@index([integrationType])
  @@map("controls")
}

enum Framework {
  SOC2
  ISO27001
  HIPAA
  GDPR
  PCI_DSS
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
}

model Evidence {
  id            String   @id @default(uuid())
  customerId    String   @map("customer_id")
  controlId     String   @map("control_id")
  integrationId String   @map("integration_id")
  data          Json
  hash          String // SHA-256 hash for immutability
  previousHash  String?  @map("previous_hash")
  s3Key         String?  @map("s3_key") // For large files
  collectedAt   DateTime @map("collected_at")
  createdAt     DateTime @default(now()) @map("created_at")

  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  control          Control           @relation(fields: [controlId], references: [id])
  integration      Integration       @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  complianceChecks ComplianceCheck[]

  @@index([customerId])
  @@index([controlId])
  @@index([collectedAt])
  @@index([hash])
  @@index([integrationId])
  @@index([customerId, controlId])
  @@index([customerId, collectedAt])
  @@map("evidence")
}

model ComplianceCheck {
  id           String      @id @default(uuid())
  customerId   String      @map("customer_id")
  controlId    String      @map("control_id")
  status       CheckStatus
  evidenceId   String?     @map("evidence_id")
  errorMessage String?     @map("error_message") @db.Text
  checkedAt    DateTime    @map("checked_at")
  nextCheckAt  DateTime?   @map("next_check_at")
  createdAt    DateTime    @default(now()) @map("created_at")

  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  control   Control    @relation(fields: [controlId], references: [id])
  evidence  Evidence?  @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  jiraTasks JiraTask[]

  @@index([customerId])
  @@index([controlId])
  @@index([status])
  @@index([checkedAt])
  @@index([customerId, status])
  @@index([customerId, checkedAt])
  @@index([customerId, controlId, checkedAt])
  @@map("compliance_checks")
}

enum CheckStatus {
  PASS
  FAIL
  WARNING
  PENDING
}

model JiraTask {
  id                String    @id @default(uuid())
  customerId        String    @map("customer_id")
  complianceCheckId String    @map("compliance_check_id")
  jiraIssueKey      String    @map("jira_issue_key")
  jiraIssueId       String    @map("jira_issue_id")
  status            String
  syncedAt          DateTime? @map("synced_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  complianceCheck ComplianceCheck @relation(fields: [complianceCheckId], references: [id], onDelete: Cascade)

  @@unique([jiraIssueKey])
  @@index([customerId])
  @@index([complianceCheckId])
  @@map("jira_tasks")
}

model AuditLog {
  id         String        @id @default(uuid())
  action     String
  severity   AuditSeverity @default(INFO)
  userId     String?       @map("user_id")
  customerId String?       @map("customer_id")
  ipAddress  String?       @map("ip_address")
  userAgent  String?       @map("user_agent")
  requestId  String?       @map("request_id")
  metadata   Json?
  createdAt  DateTime      @default(now()) @map("created_at")

  @@index([customerId])
  @@index([userId])
  @@index([action])
  @@index([severity])
  @@index([createdAt])
  @@index([customerId, action])
  @@index([customerId, userId, createdAt])
  @@map("audit_logs")
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}
