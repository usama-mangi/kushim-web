// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String    @id @default(uuid())
  email                     String    @unique
  password                  String
  firstName                 String
  lastName                  String
  role                      UserRole  @default(USER)
  customerId                String?   @map("customer_id")
  emailVerified             Boolean   @default(false) @map("email_verified")
  emailVerificationToken    String?   @unique @map("email_verification_token")
  emailVerificationExpires  DateTime? @map("email_verification_expires")
  resetPasswordToken        String?   @unique @map("reset_password_token")
  resetPasswordExpires      DateTime? @map("reset_password_expires")
  lastLoginAt               DateTime? @map("last_login_at")
  loginCount                Int       @default(0) @map("login_count")
  isActive                  Boolean   @default(true) @map("is_active")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  customer         Customer?         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  sentInvitations  UserInvitation[]  @relation("InvitedBy")
  receivedInvitation UserInvitation? @relation("InvitedUser")

  @@index([customerId])
  @@index([role])
  @@index([emailVerified])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

model UserInvitation {
  id           String           @id @default(uuid())
  email        String
  role         UserRole         @default(USER)
  token        String           @unique
  status       InvitationStatus @default(PENDING)
  customerId   String           @map("customer_id")
  invitedById  String           @map("invited_by_id")
  invitedUserId String?         @unique @map("invited_user_id")
  expiresAt    DateTime         @map("expires_at")
  acceptedAt   DateTime?        @map("accepted_at")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  invitedBy    User  @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedUser  User? @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([email])
  @@index([status])
  @@index([token])
  @@map("user_invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

model Customer {
  id        String         @id @default(uuid())
  name      String
  email     String         @unique
  plan      Plan           @default(STARTER)
  status    CustomerStatus @default(ACTIVE)
  metadata  Json?
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  users            User[]
  integrations     Integration[]
  complianceChecks ComplianceCheck[]
  evidence         Evidence[]
  jiraTasks        JiraTask[]
  policies         Policy[]

  @@index([email])
  @@index([status])
  @@map("customers")
}

enum Plan {
  STARTER
  GROWTH
  ENTERPRISE
}

enum CustomerStatus {
  ACTIVE
  SUSPENDED
  CANCELED
}

model Integration {
  id          String            @id @default(uuid())
  customerId  String            @map("customer_id")
  type        IntegrationType
  status      IntegrationStatus @default(DISCONNECTED)
  config      Json // Encrypted credentials
  lastSyncAt  DateTime?         @map("last_sync_at")
  healthScore Decimal?          @map("health_score") @db.Decimal(3, 2)
  errorCount  Int               @default(0) @map("error_count")
  lastError   String?           @map("last_error")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  customer Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  evidence Evidence[]

  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([customerId, type])
  @@index([customerId, status])
  @@map("integrations")
}

enum IntegrationType {
  AWS
  GITHUB
  OKTA
  JIRA
  SLACK
}

enum IntegrationStatus {
  ACTIVE
  FAILED
  DISCONNECTED
  SYNCING
}

model Control {
  id              String           @id @default(uuid())
  framework       Framework
  controlId       String           @map("control_id") // e.g., CC6.1, A1.2
  title           String
  description     String           @db.Text
  testProcedure   String           @map("test_procedure") @db.Text
  frequency       Frequency
  category        String?
  integrationType IntegrationType?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  complianceChecks       ComplianceCheck[]
  evidence               Evidence[]
  evidenceMappings       EvidenceMapping[]
  policyTemplateControls PolicyTemplateControl[]

  @@unique([framework, controlId])
  @@index([framework])
  @@index([category])
  @@index([integrationType])
  @@map("controls")
}

enum Framework {
  SOC2
  ISO27001
  HIPAA
  GDPR
  PCI_DSS
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
}

model Evidence {
  id            String   @id @default(uuid())
  customerId    String   @map("customer_id")
  controlId     String   @map("control_id")
  integrationId String   @map("integration_id")
  data          Json
  hash          String // SHA-256 hash for immutability
  previousHash  String?  @map("previous_hash")
  s3Key         String?  @map("s3_key") // For large files
  collectedAt   DateTime @map("collected_at")
  createdAt     DateTime @default(now()) @map("created_at")

  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  control          Control           @relation(fields: [controlId], references: [id])
  integration      Integration       @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  complianceChecks ComplianceCheck[]
  evidenceMappings EvidenceMapping[]

  @@index([customerId])
  @@index([controlId])
  @@index([collectedAt])
  @@index([hash])
  @@index([integrationId])
  @@index([customerId, controlId])
  @@index([customerId, collectedAt])
  @@map("evidence")
}

model ComplianceCheck {
  id           String      @id @default(uuid())
  customerId   String      @map("customer_id")
  controlId    String      @map("control_id")
  status       CheckStatus
  evidenceId   String?     @map("evidence_id")
  errorMessage String?     @map("error_message") @db.Text
  checkedAt    DateTime    @map("checked_at")
  nextCheckAt  DateTime?   @map("next_check_at")
  createdAt    DateTime    @default(now()) @map("created_at")

  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  control   Control    @relation(fields: [controlId], references: [id])
  evidence  Evidence?  @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  jiraTasks JiraTask[]

  @@index([customerId])
  @@index([controlId])
  @@index([status])
  @@index([checkedAt])
  @@index([customerId, status])
  @@index([customerId, checkedAt])
  @@index([customerId, controlId, checkedAt])
  @@map("compliance_checks")
}

enum CheckStatus {
  PASS
  FAIL
  WARNING
  PENDING
}

model JiraTask {
  id                String    @id @default(uuid())
  customerId        String    @map("customer_id")
  complianceCheckId String    @map("compliance_check_id")
  jiraIssueKey      String    @map("jira_issue_key")
  jiraIssueId       String    @map("jira_issue_id")
  status            String
  syncedAt          DateTime? @map("synced_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  complianceCheck ComplianceCheck @relation(fields: [complianceCheckId], references: [id], onDelete: Cascade)

  @@unique([jiraIssueKey])
  @@index([customerId])
  @@index([complianceCheckId])
  @@map("jira_tasks")
}

model AuditLog {
  id         String        @id @default(uuid())
  action     String
  severity   AuditSeverity @default(INFO)
  userId     String?       @map("user_id")
  customerId String?       @map("customer_id")
  ipAddress  String?       @map("ip_address")
  userAgent  String?       @map("user_agent")
  requestId  String?       @map("request_id")
  metadata   Json?
  createdAt  DateTime      @default(now()) @map("created_at")

  @@index([customerId])
  @@index([userId])
  @@index([action])
  @@index([severity])
  @@index([createdAt])
  @@index([customerId, action])
  @@index([customerId, userId, createdAt])
  @@map("audit_logs")
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

model EvidenceMapping {
  id                String   @id @default(uuid())
  evidenceId        String   @map("evidence_id")
  controlId         String   @map("control_id")
  confidence        Decimal  @db.Decimal(3, 2) // 0.00 to 1.00
  aiReasoning       String   @db.Text @map("ai_reasoning")
  isManualOverride  Boolean  @default(false) @map("is_manual_override")
  manuallyVerified  Boolean  @default(false) @map("manually_verified")
  createdBy         String?  @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  evidence Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  control  Control  @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([evidenceId, controlId])
  @@index([evidenceId])
  @@index([controlId])
  @@index([confidence])
  @@index([isManualOverride])
  @@index([manuallyVerified])
  @@map("evidence_mappings")
}

model AIPromptTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  template    String   @db.Text
  variables   Json // List of required variables
  isActive    Boolean  @default(true) @map("is_active")
  version     Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  usageLogs AIUsageLog[]

  @@index([name])
  @@index([isActive])
  @@map("ai_prompt_templates")
}

model AIUsageLog {
  id                 String   @id @default(uuid())
  customerId         String   @map("customer_id")
  promptTemplateId   String?  @map("prompt_template_id")
  model              String
  promptTokens       Int      @map("prompt_tokens")
  completionTokens   Int      @map("completion_tokens")
  totalTokens        Int      @map("total_tokens")
  estimatedCostUsd   Decimal  @db.Decimal(10, 6) @map("estimated_cost_usd")
  operation          String // e.g., "evidence_mapping", "control_recommendation"
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")

  promptTemplate AIPromptTemplate? @relation(fields: [promptTemplateId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([operation])
  @@index([createdAt])
  @@index([customerId, operation])
  @@index([customerId, createdAt])
  @@map("ai_usage_logs")
}

model PolicyTemplate {
  id              String   @id @default(uuid())
  name            String
  category        String
  description     String   @db.Text
  templateContent String   @db.Text @map("template_content")
  variables       Json // Array of customizable fields
  framework       Framework @default(SOC2)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  policies             Policy[]
  policyTemplateControls PolicyTemplateControl[]

  @@index([category])
  @@index([framework])
  @@index([isActive])
  @@map("policy_templates")
}

model PolicyTemplateControl {
  id               String   @id @default(uuid())
  policyTemplateId String   @map("policy_template_id")
  controlId        String   @map("control_id")
  createdAt        DateTime @default(now()) @map("created_at")

  policyTemplate PolicyTemplate @relation(fields: [policyTemplateId], references: [id], onDelete: Cascade)
  control        Control        @relation(fields: [controlId], references: [id], onDelete: Cascade)

  @@unique([policyTemplateId, controlId])
  @@index([policyTemplateId])
  @@index([controlId])
  @@map("policy_template_controls")
}

model Policy {
  id           String       @id @default(uuid())
  customerId   String       @map("customer_id")
  templateId   String       @map("template_id")
  title        String
  content      String       @db.Text
  version      Int          @default(1)
  status       PolicyStatus @default(DRAFT)
  createdBy    String       @map("created_by")
  reviewedBy   String?      @map("reviewed_by")
  approvedBy   String?      @map("approved_by")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  reviewedAt   DateTime?    @map("reviewed_at")
  approvedAt   DateTime?    @map("approved_at")

  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  template        PolicyTemplate  @relation(fields: [templateId], references: [id])
  policyVersions  PolicyVersion[]

  @@index([customerId])
  @@index([templateId])
  @@index([status])
  @@index([createdBy])
  @@index([customerId, status])
  @@index([customerId, templateId])
  @@map("policies")
}

enum PolicyStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  ARCHIVED
}

model PolicyVersion {
  id        String   @id @default(uuid())
  policyId  String   @map("policy_id")
  version   Int
  title     String
  content   String   @db.Text
  changes   String?  @db.Text
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@unique([policyId, version])
  @@index([policyId])
  @@index([createdAt])
  @@map("policy_versions")
}

model CopilotConversation {
  id            String               @id @default(uuid())
  customerId    String               @map("customer_id")
  userId        String               @map("user_id")
  title         String
  status        ConversationStatus   @default(ACTIVE)
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  lastMessageAt DateTime?            @map("last_message_at")

  messages CopilotMessage[]

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([customerId, userId])
  @@index([customerId, status])
  @@index([lastMessageAt])
  @@map("copilot_conversations")
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
}

model CopilotMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           MessageRole
  content        String   @db.Text
  metadata       Json?    // sources, controls, policies referenced
  tokens         Int?
  cost           Decimal? @db.Decimal(10, 6)
  createdAt      DateTime @default(now()) @map("created_at")

  conversation CopilotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@map("copilot_messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}
