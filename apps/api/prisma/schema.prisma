// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Role {
  id    String @id @default(uuid()) @db.Uuid
  name  String @unique
  users User[]

  @@map("roles")
}

model User {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  passwordHash String    @map("password_hash")
  roleId       String    @map("role_id") @db.Uuid
  lastLogin    DateTime? @map("last_login")
  mfaSecret    String?   @map("mfa_secret")
  mfaEnabled   Boolean   @default(false) @map("mfa_enabled")
  
  role         Role             @relation(fields: [roleId], references: [id])
  dataSources  DataSource[]
  records      UnifiedRecord[]
  activityLogs ActivityLog[]

  @@map("users")
}

model DataSource {
  id                   String   @id @default(uuid()) @db.Uuid
  userId               String   @map("user_id") @db.Uuid
  providerName         String   @map("provider_name")
  credentialsEncrypted Json     @map("credentials_encrypted")
  status               String   @default("active")
  lastSync             DateTime? @map("last_sync")
  metadata             Json?    @map("metadata")
  createdAt            DateTime @default(now()) @map("created_at")

  user                 User            @relation(fields: [userId], references: [id])
  records              UnifiedRecord[]

  @@map("data_sources")
}

model UnifiedRecord {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  sourceId       String   @map("source_id") @db.Uuid
  externalId     String   @map("external_id")
  sourcePlatform String   @map("source_platform")
  artifactType   String   @map("artifact_type")
  title          String
  body           String   @db.Text
  url            String?
  author         String
  timestamp      DateTime
  participants   String[]
  metadata       Json
  checksum       String   @unique
  embedding      Json?    @map("embedding")

  user   User       @relation(fields: [userId], references: [id])
  source DataSource @relation(fields: [sourceId], references: [id])
  
  linksAsSource Link[] @relation("SourceRecord")
  linksAsTarget Link[] @relation("TargetRecord")

  @@index([userId, sourceId], name: "idx_records_user_source")
  @@index([sourcePlatform, artifactType], name: "idx_records_platform_type")
  @@index([timestamp], name: "idx_records_timestamp")
  @@map("unified_records")
}

model Link {
  id               String   @id @default(uuid()) @db.Uuid
  sourceRecordId   String   @map("source_record_id") @db.Uuid
  targetRecordId   String   @map("target_record_id") @db.Uuid
  confidenceScore  Float    @map("confidence_score")
  relationshipType String   @map("relationship_type")
  discoveryMethod  String   @map("discovery_method")
  metadata         Json?    @map("metadata")
  createdAt        DateTime @default(now()) @map("created_at")

  sourceRecord UnifiedRecord @relation("SourceRecord", fields: [sourceRecordId], references: [id])
  targetRecord UnifiedRecord @relation("TargetRecord", fields: [targetRecordId], references: [id])

  @@unique([sourceRecordId, targetRecordId])
  @@map("links")
}

model ShadowLink {
  id                   String   @id @default(uuid()) @db.Uuid
  sourceRecordId       String   @map("source_record_id") @db.Uuid
  targetRecordId       String   @map("target_record_id") @db.Uuid
  deterministicScore   Float    @map("deterministic_score")
  semanticScore        Float    @map("semantic_score")
  structuralScore      Float    @map("structural_score")
  mlScore              Float    @map("ml_score")
  createdAt            DateTime @default(now()) @map("created_at")

  @@unique([sourceRecordId, targetRecordId])
  @@index([mlScore], name: "idx_shadow_links_ml_score")
  @@index([createdAt], name: "idx_shadow_links_created")
  @@map("shadow_links")
}

model ActivityLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  action    String
  resource  String
  payload   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([createdAt(sort: Desc)], name: "idx_audit_created")
  @@map("activity_logs")
}